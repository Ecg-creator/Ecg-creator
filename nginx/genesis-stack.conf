# Genesis Stack Virtual Host Configuration
# BelieversCommons Unified API Gateway

upstream genesis_api {
    least_conn;
    server genesis-api:8080 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream riveros_api {
    least_conn;
    server riveros-api:8081 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream synergizeos_api {
    least_conn;
    server synergizeos-api:8082 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream ecg_compliance {
    least_conn;
    server ecg-compliance:8083 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream mahdi_playground {
    least_conn;
    server mahdi-playground:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream prometheus_metrics {
    server prometheus-metrics:9090;
}

upstream grafana_dashboard {
    server grafana-dashboard:3001;
}

# Main Genesis Stack Server
server {
    listen 80;
    listen 443 ssl http2;
    server_name genesis.believers-commons.org api.believers-commons.org;
    
    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/genesis.crt;
    ssl_certificate_key /etc/nginx/ssl/genesis.key;
    ssl_trusted_certificate /etc/nginx/ssl/cloudflare-ca.pem;
    
    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Genesis-Stack "BelieversCommons-v1.0" always;
    add_header X-Revenue-Target "â‚¹3.7Cr" always;
    
    # Root health check
    location / {
        return 301 https://$server_name/api/v1/health;
    }
    
    # Genesis API - Core BelieversCommons services
    location /api/v1/genesis/ {
        limit_req zone=api burst=20 nodelay;
        
        proxy_pass http://genesis_api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Genesis-Component "empire";
        proxy_cache_bypass $http_upgrade;
        
        # Timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # RiverOS - Transaction and revenue management
    location /api/v1/river/ {
        limit_req zone=api burst=50 nodelay;
        
        proxy_pass http://riveros_api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Genesis-Component "river";
        proxy_set_header X-Revenue-Share "85:15";
        
        # Revenue optimization caching
        proxy_cache_valid 200 302 5m;
        proxy_cache_valid 404 1m;
    }
    
    # SynergizeOS - Cross-platform orchestration
    location /api/v1/synergize/ {
        limit_req zone=api burst=30 nodelay;
        
        proxy_pass http://synergizeos_api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Genesis-Component "synergize";
        proxy_set_header X-Compliance-Mode "automated";
    }
    
    # ECG Compliance Framework
    location /api/v1/compliance/ {
        limit_req zone=api burst=10 nodelay;
        
        proxy_pass http://ecg_compliance/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-ECG-Charter "Article-2.1,Article-4";
        proxy_set_header X-DPDPA-2023 "enabled";
        
        # Compliance logging
        access_log /var/log/nginx/compliance.log genesis_log;
    }
    
    # MAHDI Ruby Sandbox
    location /mahdi/ {
        limit_req zone=api burst=15 nodelay;
        
        proxy_pass http://mahdi_playground/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-MAHDI-Mode "premium";
        proxy_cache_bypass $http_upgrade;
        
        # WebSocket support for live coding
        proxy_read_timeout 86400;
    }
    
    # Unified health check endpoint
    location /api/v1/health {
        limit_req zone=general burst=100 nodelay;
        
        proxy_pass http://genesis_api/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Health check caching
        proxy_cache_valid 200 30s;
    }
    
    # Revenue optimization endpoint
    location /api/v1/revenue {
        limit_req zone=api burst=5 nodelay;
        
        proxy_pass http://genesis_api/api/v1/revenue;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Revenue-Analytics "enabled";
        
        # Cache revenue summaries
        proxy_cache_valid 200 1m;
    }
}

# Monitoring Dashboard Server
server {
    listen 80;
    listen 443 ssl http2;
    server_name monitor.believers-commons.org;
    
    ssl_certificate /etc/nginx/ssl/genesis.crt;
    ssl_certificate_key /etc/nginx/ssl/genesis.key;
    
    # Prometheus Metrics
    location /prometheus/ {
        auth_basic "Genesis Stack Monitoring";
        auth_basic_user_file /etc/nginx/.htpasswd;
        
        proxy_pass http://prometheus_metrics/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Grafana Dashboard
    location / {
        proxy_pass http://grafana_dashboard/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# API Documentation Server
server {
    listen 80;
    listen 443 ssl http2;
    server_name docs.believers-commons.org;
    
    ssl_certificate /etc/nginx/ssl/genesis.crt;
    ssl_certificate_key /etc/nginx/ssl/genesis.key;
    
    root /var/www/docs;
    index index.html;
    
    # API documentation
    location / {
        try_files $uri $uri/ =404;
        add_header Cache-Control "public, max-age=3600";
    }
    
    # OpenAPI specification
    location /openapi.json {
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Cache-Control "public, max-age=300";
    }
}

# Security and error handling
error_page 404 /404.html;
error_page 500 502 503 504 /50x.html;

location = /50x.html {
    root /var/www/html;
}

location = /404.html {
    root /var/www/html;
}